name: Create Python Package

#######
# Creates a Python package for an arbitrary repository and subdirectory with optional attestation.
#######

on:
  workflow_call:
    inputs:
      repository:
        description: "GitHub repository to checkout; defaults to repo running this workflow."
        default: ${{ github.repository }}
        type: string
      build-subdirectory:
        description: "The subdirectory to build as a wheel."
        default: ""
        type: string
      attest:
        description: "Whether provenance attestation should be created by GitHub for the package."
        default: "false"
        type: string
    outputs:
      artifact-name:
        description: "Name of the uploaded artifact; use for artifact retrieval."
        value: ${{ jobs.package.outputs.artifact-name }}

env:
  FORCE_COLOR: "1"

jobs:
  package:
    name: Create Python Package
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      attestations: write
    outputs:
      artifact-name: ${{ steps.package.outputs.artifact-name }}
    steps:

      - name: Determine Package Name
        id: config
        run: |
          NAME=$(basename '${{ inputs.repository }}')${{ inputs.build-subdirectory && format('-{0}', inputs.build-subdirectory) || '' }}
          echo "package-name=${NAME}" | tee -a ${GITHUB_OUTPUT}

      - name: Checkout
        uses: actions/checkout@v4.1.6
        with:
          repository: ${{ inputs.repository }}
          fetch-depth: 0  # Fetch all refs so setuptools_scm can generate the correct version number

      - name: Build & Upload Package
        id: package
        uses: hynek/build-and-inspect-python-package@v2.6.0
        with:
          path: ${{ inputs.build-subdirectory || '.' }}
          upload-name-suffix: ${{ format('-{0}', steps.config.outputs.package-name) }}
          attest-build-provenance-github: ${{ inputs.attest }}
